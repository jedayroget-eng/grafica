<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gr√°fica Pro - V4.4 (Corre√ß√£o de Pre√ßos Din√¢micos)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- VARI√ÅVEIS (COM SUPORTE A DARK MODE) --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --input-bg: #ffffff;
        }
        /* --- TEMA ESCURO --- */
        body.dark-mode {
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --border: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --input-bg: #0f172a;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 50px; transition: background 0.3s, color 0.3s; }
        * { box-sizing: border-box; outline: none; }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: var(--bg-card); padding: 40px; border-radius: 12px;
            box-shadow: var(--shadow); width: 100%; max-width: 400px;
            text-align: center; border: 1px solid var(--border);
        }
        .login-card h2 { color: var(--primary); margin-bottom: 20px; }
        .login-input { margin-bottom: 15px; text-align: left; }

        /* --- HEADER & NAVBAR --- */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        /* --- LAYOUT PRINCIPAL --- */
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        #appContent { display: none; } /* Escondido at√© logar */

        /* --- BARRA DE INSER√á√ÉO --- */
        .input-bar {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--primary);
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 2fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 30px;
        }
        @media (max-width: 1100px) { .input-bar { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { .input-bar { grid-template-columns: 1fr; } }

        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--text-muted); }

        /* Inputs e Selects */
        select, input { 
            width: 100%; padding: 10px; 
            border: 1px solid var(--border); 
            border-radius: 6px; font-size: 0.95rem; 
            background: var(--input-bg);
            color: var(--text-main);
        }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* --- BOT√ïES --- */
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; margin-left: 2px; }

        /* Bot√£o Dark Mode */
        .theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-main); padding: 5px; border-radius: 50%; }
        .theme-toggle:hover { background: rgba(0,0,0,0.1); }

        /* --- PAPEL DO OR√áAMENTO --- */
        .paper {
            background: var(--bg-card);
            padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            position: relative;
            margin-bottom: 30px;
            color: var(--text-main);
        }
        .paper-header { border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .paper-total { text-align: right; margin-top: 30px; font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); font-size: 0.8rem; color: var(--text-muted); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); }

        /* Estilos de Drag and Drop */
        .draggable-row { cursor: grab; }
        .draggable-row:active { cursor: grabbing; background: var(--bg-body); }
        .draggable-row.dragging { opacity: 0.5; background: var(--border); }

        /* Input edit√°vel na tabela */
        .editable-qty {
            width: 70px;
            padding: 4px;
            text-align: center;
            border: 1px solid transparent;
            background: transparent;
            font-weight: bold;
        }
        .editable-qty:hover, .editable-qty:focus {
            border: 1px solid var(--border);
            background: var(--bg-body);
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--bg-card); width: 90%; max-width: 900px; height: 85vh;
            border-radius: 12px; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            color: var(--text-main);
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg-card); }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab-btn { padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .edit-table { width: 100%; border: 1px solid var(--border); border-radius: 8px; margin-top: 15px; }
        .edit-table th { background: var(--bg-body); }
        .rule-row { display: flex; gap: 10px; margin-bottom: 5px; background: var(--bg-body); padding: 5px; border-radius: 6px; }

        /* --- SEARCH BOX (LUPA) --- */
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { padding-left: 35px; background: var(--bg-body); }
        .search-box::before { content: "üîç"; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; opacity: 0.6; pointer-events: none; }

        /* Loading Indicator */
        #loading { position: fixed; top: 10px; right: 10px; background: #2563eb; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: none; z-index: 9999; }

        /* Datalist Custom Style (Simula√ß√£o visual na input bar) */
        .input-with-icon { position: relative; }
        .input-with-icon input { padding-left: 30px; }
        .input-with-icon::before { content: "üîç"; position: absolute; left: 10px; top: 38px; z-index: 10; font-size: 0.8rem; opacity: 0.5; pointer-events: none; }

        @media print {
            .navbar, .input-bar, .no-print, .btn, .modal-overlay, #historicoContainer, #loginScreen { display: none !important; }
            body, .container, .paper { background: white !important; color: black !important; margin: 0; padding: 0; max-width: 100%; box-shadow: none; }
            #appContent { display: block !important; }
            .editable-qty { border: none; text-align: center; width: auto; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loading">üíæ Processando...</div>

    <!-- TELA DE LOGIN -->
    <div id="loginScreen">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üñ®Ô∏è</div>
            <h2>Gr√°fica Pro</h2>
            <div class="login-input">
                <label>Usu√°rio</label>
                <input type="text" id="loginUser" placeholder="Ex: Admin">
            </div>
            <div class="login-input">
                <label>Senha</label>
                <input type="password" id="loginPass" placeholder="****">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="fazerLogin()">ENTRAR</button>
            <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted);">Senha padr√£o: 1234</p>
        </div>
    </div>

    <!-- CONTE√öDO DO SISTEMA -->
    <div id="appContent">
        <div class="navbar no-print">
            <div class="brand">‚òÅÔ∏è Gr√°fica Pro <span id="userDisplay" style="font-size: 0.8rem; background: var(--bg-body); padding: 2px 8px; border-radius: 10px; margin-left: 10px; color: var(--text-muted);"></span></div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="theme-toggle" onclick="toggleTheme()" title="Mudar Tema">üåì</button>
                <div style="width: 1px; height: 20px; background: var(--border); margin: 0 5px;"></div>
                <button class="btn btn-outline" onclick="openModal('tabClientes')">üë§ Clientes</button>
                <button class="btn btn-outline" onclick="openModal('tabProdutos')">üì¶ Produtos</button>
                <button class="btn btn-primary" onclick="openModal('tabProdutos')">‚öôÔ∏è Cadastros</button>
                <button class="btn btn-sm btn-danger" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="container">
            <div class="input-bar no-print">
                <!-- BUSCA CLIENTE COM LUPA -->
                <div class="form-group input-with-icon">
                    <label>Buscar Cliente</label>
                    <input list="listClientes" id="inputBuscaCli" placeholder="Digite para buscar..." onchange="updateCliInfo()">
                    <datalist id="listClientes"></datalist>
                </div>

                <!-- BUSCA PRODUTO COM LUPA -->
                <div class="form-group input-with-icon">
                    <label>Buscar Produto</label>
                    <input list="listProdutos" id="inputBuscaProd" placeholder="Digite para buscar...">
                    <datalist id="listProdutos"></datalist>
                </div>

                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="calcQty" value="1000">
                </div>

                <div class="form-group">
                    <label>Servi√ßo / Arte</label>
                    <select id="selectArte"></select>
                </div>

                <div class="form-group">
                    <label>Pagamento</label>
                    <select id="selectPagamento" onchange="updateOrcamentoVisual()">
                        <option value="Pix">Pix</option>
                        <option value="Cr√©dito">Cr√©dito</option>
                        <option value="D√©bito">D√©bito</option>
                        <option value="Dinheiro">Dinheiro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="addItem()">‚ûï ADICIONAR</button>
                </div>
            </div>

            <div class="paper" id="areaPrintavel">
                <div class="paper-header">
                    <div>
                        <h1 style="margin:0; color:var(--primary)">OR√áAMENTO #<span id="orcNumeroDisplay">000</span></h1>
                        <p style="margin:5px 0; color:var(--text-muted)">Data: <span id="orcData">--/--/--</span></p>
                    </div>
                    <div style="text-align: right;">
                        <strong>Pagamento:</strong> <span id="resPagamento">Pix</span><br>
                        <span style="font-size: 0.8rem; color:#ef4444;">V√°lido por 5 dias</span>
                    </div>
                </div>

                <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size:0.7rem; font-weight:bold; color:var(--text-muted)">CLIENTE</div>
                        <div id="resCliNome" style="font-weight:bold; font-size:1.1rem">---</div>
                        <div id="resCliDoc" style="font-size:0.9rem">---</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; font-weight:bold; color:var(--text-muted)">CONTATO</div>
                        <div id="resCliFone">---</div>
                        <div id="resCliEnd" style="font-size:0.9rem">---</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th style="width: 30px" class="no-print"></th> <!-- Handle Drag -->
                            <th>DESCRI√á√ÉO</th>
                            <th style="text-align: center; width: 100px">QTD</th>
                            <th style="text-align: right; width: 120px">UNIT (R$)</th>
                            <th style="text-align: right; width: 120px">TOTAL (R$)</th>
                            <th class="no-print" style="width: 90px; text-align: center;">A√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody id="orcBody"></tbody>
                </table>

                <div class="paper-total">
                    Total: <span id="resTotal">R$ 0,00</span>
                </div>
            </div>

            <div class="no-print" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-danger" onclick="limparOrcamento()">üóëÔ∏è Limpar</button>
                <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-success" onclick="finalizarOrcamento()">üíæ Salvar no Hist√≥rico</button>
            </div>

            <div id="historicoContainer" class="no-print" style="margin-top: 50px;">
                <h3>üìú Hist√≥rico de Pedidos (Nuvem)</h3>
                <div style="background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); overflow: hidden;">
                    <table class="edit-table" id="historicoTable" style="margin:0; border:none">
                        <thead><tr><th>#</th><th>Data</th><th>Cliente</th><th>Valor</th><th style="text-align:right">A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Gerenciamento do Sistema</h3>
                <button class="btn btn-sm btn-danger" onclick="closeModal()">Fechar (X)</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab(event, 'tabProdutos')">üì¶ Produtos & Pre√ßos</button>
                    <button class="tab-btn" onclick="openTab(event, 'tabClientes')">üë§ Clientes</button>
                    <button class="tab-btn" onclick="openTab(event, 'tabArtes')">üé® Servi√ßos/Artes</button>
                </div>

                <!-- ABA PRODUTOS -->
                <div id="tabProdutos" class="tab-content active">
                    <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <input type="hidden" id="editProdId">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div><label>Nome Produto:</label><input type="text" id="prodNome"></div>
                            <div><label>Pre√ßo Base:</label><input type="number" id="prodPreco" step="0.001"></div>
                            <div><label>Estoque:</label><input type="number" id="prodEstoque" placeholder="0"></div>
                        </div>
                        <label>Tabela de Atacado (Regras de Pre√ßo):</label>
                        <div id="rulesContainer"></div>
                        <button class="btn btn-sm btn-outline" onclick="addRuleField()">+ Faixa de Pre√ßo</button>

                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" id="btnSalvarProd" onclick="saveProduct()">Salvar Produto</button>
                            <button class="btn btn-danger" id="btnCancelaProd" onclick="resetProdForm()" style="display:none">Cancelar Edi√ß√£o</button>
                        </div>
                    </div>

                    <!-- BARRA DE ORDENA√á√ÉO E BUSCA -->
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div class="search-box" style="flex: 1; margin-bottom: 0;">
                            <input type="text" placeholder="Pesquisar produto..." onkeyup="filterTable(this, 'prodTable')">
                        </div>
                        <select style="width: auto;" onchange="sortProducts(this.value)">
                            <option value="nome">Ordenar: Nome (A-Z)</option>
                            <option value="valor_cres">Ordenar: Valor (Menor > Maior)</option>
                            <option value="valor_dec">Ordenar: Valor (Maior > Menor)</option>
                            <option value="estoque">Ordenar: Estoque</option>
                        </select>
                    </div>

                    <table class="edit-table" id="prodTable"><tbody></tbody></table>
                </div>

                <!-- ABA CLIENTES -->
                <div id="tabClientes" class="tab-content">
                    <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <input type="hidden" id="editCliId">
                        <input type="text" id="cliNome" placeholder="Nome Completo" style="margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="cliDoc" placeholder="CPF/CNPJ">
                            <input type="text" id="cliFone" placeholder="WhatsApp">
                        </div>
                        <input type="text" id="cliEnd" placeholder="Endere√ßo" style="margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" id="btnSalvarCli" onclick="saveCliente()">Salvar Cliente</button>
                            <button class="btn btn-danger" id="btnCancelaCli" onclick="resetCliForm()" style="display:none">Cancelar</button>
                        </div>
                    </div>
                    <div class="search-box"><input type="text" placeholder="Pesquisar cliente..." onkeyup="filterTable(this, 'cliTable')"></div>
                    <table class="edit-table" id="cliTable"><tbody></tbody></table>
                </div>

                <!-- ABA ARTES -->
                <div id="tabArtes" class="tab-content">
                    <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <input type="hidden" id="editArteId">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="arteNome" placeholder="Nome do Servi√ßo (ex: Cria√ß√£o de Arte)">
                            <input type="number" id="artePreco" step="0.001" placeholder="R$">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" id="btnSalvarArte" onclick="saveArte()">Salvar Servi√ßo</button>
                            <button class="btn btn-danger" id="btnCancelaArte" onclick="resetArteForm()" style="display:none">Cancelar</button>
                        </div>
                    </div>
                    <div class="search-box"><input type="text" placeholder="Pesquisar servi√ßo..." onkeyup="filterTable(this, 'arteTable')"></div>
                    <table class="edit-table" id="arteTable"><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

<!-- IMPORTANDO FIREBASE -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // SUAS CHAVES DO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBLNQrxlrVmnkWhKBtvCDi9cXHSYkUKlJc",
        authDomain: "graficapro-d2d41.firebaseapp.com",
        projectId: "graficapro-d2d41",
        storageBucket: "graficapro-d2d41.firebasestorage.app",
        messagingSenderId: "144981396803",
        appId: "1:144981396803:web:a44bc7af50fd6c139cf3f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let products = [];
    let artes = [];
    let clientes = [];
    let historico = [];
    let orcamentoItens = [];
    let usuarios = [];

    // --- FUN√á√ïES DE LOGIN E USU√ÅRIOS ---
    async function initUsers() {
        const q = query(collection(db, "usuarios"));
        const snap = await getDocs(q);
        if (snap.empty) {
            console.log("Criando usu√°rios padr√£o...");
            const defaultUsers = [
                { user: 'Gracy', pass: '1234' },
                { user: 'Romulo', pass: '1234' },
                { user: 'Admin', pass: '1234' },
                { user: 'Usuario', pass: '1234' }
            ];
            for (const u of defaultUsers) {
                await addDoc(collection(db, "usuarios"), u);
            }
            alert("Usu√°rios padr√£o criados: Gracy, Romulo, Admin, Usuario (Senha: 1234)");
        }
    }

    window.fazerLogin = async () => {
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;
        showLoading(true);
        const q = query(collection(db, "usuarios"), where("user", "==", user), where("pass", "==", pass));
        const snap = await getDocs(q);
        showLoading(false);

        if (!snap.empty) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('userDisplay').innerText = user;
            loadAllData();
        } else {
            alert("Usu√°rio ou senha incorretos!");
        }
    };

    window.logout = () => {
        location.reload();
    };

    // --- DARK MODE ---
    window.toggleTheme = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('grafica_theme', isDark ? 'dark' : 'light');
    };

    // --- FUN√á√ïES DE DADOS ---
    async function loadData(collectionName) {
        showLoading(true);
        const q = query(collection(db, collectionName));
        const querySnapshot = await getDocs(q);
        const data = [];
        querySnapshot.forEach((doc) => {
            data.push({ id: doc.id, ...doc.data() });
        });
        showLoading(false);
        return data;
    }

    async function saveData(collectionName, data, id = null) {
        showLoading(true);
        try {
            if (id) {
                await updateDoc(doc(db, collectionName, id), data);
            } else {
                await addDoc(collection(db, collectionName), data);
            }
            await loadAllData();
        } catch (e) {
            alert("Erro ao salvar: " + e.message);
        }
        showLoading(false);
    }

    async function deleteData(collectionName, id) {
        if(!confirm('Tem certeza que deseja apagar?')) return;
        showLoading(true);
        try {
            await deleteDoc(doc(db, collectionName, id));
            await loadAllData();
        } catch (e) {
            alert("Erro ao apagar: " + e.message);
        }
        showLoading(false);
    }

    async function loadAllData() {
        products = await loadData("produtos");
        clientes = await loadData("clientes");
        artes = await loadData("artes");

        // ORDENA√á√ÉO PADR√ÉO (ALFAB√âTICA)
        products.sort((a, b) => a.nome.localeCompare(b.nome));
        clientes.sort((a, b) => a.nome.localeCompare(b.nome));

        const histRef = collection(db, "historico");
        const qHist = query(histRef, orderBy("numero", "desc"));
        const histSnap = await getDocs(qHist);
        historico = [];
        histSnap.forEach((doc) => {
            historico.push({ id: doc.id, ...doc.data() });
        });

        render();
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // --- EXPORTS ---
    window.saveCliente = async () => {
        const id = document.getElementById('editCliId').value;
        const cli = { 
            nome: document.getElementById('cliNome').value, 
            doc: document.getElementById('cliDoc').value || '---', 
            fone: document.getElementById('cliFone').value || '---', 
            end: document.getElementById('cliEnd').value || '---' 
        };
        if(!cli.nome) return alert("Nome obrigat√≥rio");
        await saveData("clientes", cli, id || null);
        resetCliForm();
    };

    window.saveArte = async () => {
        const id = document.getElementById('editArteId').value;
        const arte = { 
            nome: document.getElementById('arteNome').value, 
            preco: parseFloat(document.getElementById('artePreco').value) 
        };
        if(!arte.nome || isNaN(arte.preco)) return;
        await saveData("artes", arte, id || null);
        resetArteForm();
    };

    window.saveProduct = async () => {
        const id = document.getElementById('editProdId').value;
        const qtys = document.querySelectorAll('.rule-qty'); 
        const prices = document.querySelectorAll('.rule-price');
        let rules = []; 
        qtys.forEach((q, i) => { if(q.value) rules.push({ qty: parseInt(q.value), price: parseFloat(prices[i].value) }); });

        const prod = { 
            nome: document.getElementById('prodNome').value, 
            precoBase: parseFloat(document.getElementById('prodPreco').value), 
            estoque: parseInt(document.getElementById('prodEstoque').value) || 0, // NOVO CAMPO
            rules: rules.sort((a,b)=>b.qty-a.qty) 
        };

        if(!prod.nome || isNaN(prod.precoBase)) return;
        await saveData("produtos", prod, id || null);
        resetProdForm();
    };

    window.finalizarOrcamento = async () => {
        if(orcamentoItens.length === 0) return alert("Vazio!");
        const maxNum = historico.length > 0 ? Math.max(...historico.map(h => h.numero)) : 0;
        const nextNum = maxNum + 1;
        const orc = { 
            numero: nextNum, 
            data: document.getElementById('orcData').innerText, 
            cliente: { 
                nome: document.getElementById('resCliNome').innerText, 
                doc: document.getElementById('resCliDoc').innerText, 
                fone: document.getElementById('resCliFone').innerText, 
                end: document.getElementById('resCliEnd').innerText 
            }, 
            total: document.getElementById('resTotal').innerText, 
            pagamento: document.getElementById('selectPagamento').value, 
            itens: [...orcamentoItens] 
        };
        await saveData("historico", orc);
        alert("Salvo na nuvem com sucesso!");
    };

    window.deleteItem = (type, id) => {
        let collectionName = "";
        if(type === 'grafica_clis') collectionName = "clientes";
        if(type === 'grafica_artes') collectionName = "artes";
        if(type === 'grafica_prods') collectionName = "produtos";
        deleteData(collectionName, id);
    };

    window.deleteHistorico = (id) => { deleteData("historico", id); };

    window.editCliente = (id) => {
        const c = clientes.find(x => x.id == id);
        document.getElementById('editCliId').value = c.id; document.getElementById('cliNome').value = c.nome; document.getElementById('cliDoc').value = c.doc; document.getElementById('cliFone').value = c.fone; document.getElementById('cliEnd').value = c.end;
        document.getElementById('btnSalvarCli').innerText = "Atualizar"; document.getElementById('btnCancelaCli').style.display = "block";
    };

    window.resetCliForm = () => { document.getElementById('editCliId').value = ""; document.getElementById('cliNome').value = ""; document.getElementById('cliDoc').value = ""; document.getElementById('cliFone').value = ""; document.getElementById('cliEnd').value = ""; document.getElementById('btnSalvarCli').innerText = "Salvar Cliente"; document.getElementById('btnCancelaCli').style.display = "none"; };

    window.editArte = (id) => {
        const a = artes.find(x => x.id == id);
        document.getElementById('editArteId').value = a.id; document.getElementById('arteNome').value = a.nome; document.getElementById('artePreco').value = a.preco;
        document.getElementById('btnCancelaArte').style.display = "block";
    };

    window.resetArteForm = () => { document.getElementById('editArteId').value = ""; document.getElementById('arteNome').value = ""; document.getElementById('artePreco').value = ""; document.getElementById('btnCancelaArte').style.display = "none"; };

    window.editProd = (id) => {
        const p = products.find(x => x.id == id);
        document.getElementById('editProdId').value = p.id; 
        document.getElementById('prodNome').value = p.nome; 
        document.getElementById('prodPreco').value = p.precoBase;
        document.getElementById('prodEstoque').value = p.estoque || 0; // Carrega estoque

        const container = document.getElementById('rulesContainer'); container.innerHTML = '';
        if(p.rules && p.rules.length > 0) p.rules.forEach(r => { const div = document.createElement('div'); div.className = 'rule-row'; div.innerHTML = `<input type="number" class="rule-qty" value="${r.qty}"><input type="number" class="rule-price" step="0.001" value="${r.price}"><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>`; container.appendChild(div); });
        else addRuleField();

        document.getElementById('btnSalvarProd').innerText = "Atualizar"; document.getElementById('btnCancelaProd').style.display = "block";
    };

    window.resetProdForm = () => { 
        document.getElementById('editProdId').value = ""; 
        document.getElementById('prodNome').value = ""; 
        document.getElementById('prodPreco').value = ""; 
        document.getElementById('prodEstoque').value = ""; 
        document.getElementById('rulesContainer').innerHTML = ''; 
        addRuleField(); 
        document.getElementById('btnSalvarProd').innerText = "Salvar Produto"; 
        document.getElementById('btnCancelaProd').style.display = "none"; 
    };

    window.addRuleField = () => { const div = document.createElement('div'); div.className = 'rule-row'; div.innerHTML = `<input type="number" class="rule-qty" placeholder="Qtd"><input type="number" class="rule-price" step="0.001" placeholder="R$ Un."><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>`; document.getElementById('rulesContainer').appendChild(div); };

    window.filterTable = (input, tableId) => {
        const term = input.value.toLowerCase();
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    };

    // --- NOVA FUN√á√ÉO DE ORDENA√á√ÉO ---
    window.sortProducts = (criteria) => {
        if(criteria === 'nome') {
            products.sort((a, b) => a.nome.localeCompare(b.nome));
        } else if (criteria === 'valor_cres') {
            products.sort((a, b) => a.precoBase - b.precoBase);
        } else if (criteria === 'valor_dec') {
            products.sort((a, b) => b.precoBase - a.precoBase);
        } else if (criteria === 'estoque') {
            products.sort((a, b) => (b.estoque || 0) - (a.estoque || 0)); // Maior estoque primeiro
        }
        renderModalTables();
    };

    window.openModal = (tabName) => { document.getElementById('settingsModal').style.display = 'flex'; if(tabName) openTab(null, tabName); };
    window.closeModal = () => { document.getElementById('settingsModal').style.display = 'none'; render(); };

    window.openTab = (evt, tabName) => {
        let tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
        let tablinks = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.className += " active";
        else {
            const btns = document.querySelectorAll('.tab-btn');
            if(tabName === 'tabProdutos') btns[0].className += " active";
            if(tabName === 'tabClientes') btns[1].className += " active";
            if(tabName === 'tabArtes') btns[2].className += " active";
        }
    };

    window.updateCliInfo = () => {
        // Busca pelo nome no input list
        const val = document.getElementById('inputBuscaCli').value;
        const c = clientes.find(x => x.nome === val);
        if(c) { 
            document.getElementById('resCliNome').innerText = c.nome; document.getElementById('resCliDoc').innerText = c.doc; 
            document.getElementById('resCliFone').innerText = c.fone; document.getElementById('resCliEnd').innerText = c.end; 
        }
    };

    // --- FUN√á√ÉO AUXILIAR PARA CALCULAR PRE√áO ---
    function getProductPrice(productName, qty) {
        const p = products.find(x => x.nome === productName);
        if (!p) return 0; // Se n√£o achar o produto (ex: √© um servi√ßo), retorna 0 ou trata diferente

        let unit = p.precoBase;
        if (p.rules) {
            for (let r of p.rules) {
                if (qty >= r.qty) {
                    unit = r.price;
                    break;
                }
            }
        }
        return unit;
    }

    window.addItem = () => {
        // Pega valor do input list de produtos
        const pVal = document.getElementById('inputBuscaProd').value;
        const p = products.find(x => x.nome === pVal);
        if(!p) return alert("Selecione um produto v√°lido da lista");

        const qty = parseInt(document.getElementById('calcQty').value) || 0;
        const aPreco = parseFloat(document.getElementById('selectArte').value) || 0;
        const aNome = document.getElementById('selectArte').options[document.getElementById('selectArte').selectedIndex].text;

        // Usa a fun√ß√£o auxiliar para garantir consist√™ncia
        let unit = getProductPrice(p.nome, qty);

        orcamentoItens.push({ desc: p.nome, qty: qty, unit: unit, sub: qty * unit, isSubItem: false });

        if(aPreco > 0) {
            orcamentoItens.push({ desc: `${aNome} (ref. ${p.nome})`, qty: 1, unit: aPreco, sub: aPreco, isSubItem: true });
        }

        renderOrcamento();
        // Limpa campos
        document.getElementById('inputBuscaProd').value = '';
    };

    // --- FUN√á√ïES DE MANIPULA√á√ÉO DO OR√áAMENTO (CORRIGIDAS) ---

    window.removeOrcItem = (index) => {
        orcamentoItens.splice(index, 1);
        renderOrcamento();
    };

    window.duplicateOrcItem = (index) => {
        const item = orcamentoItens[index];
        // Cria uma c√≥pia do objeto para n√£o referenciar o mesmo
        orcamentoItens.splice(index + 1, 0, { ...item });
        renderOrcamento();
    };

    // --- CORRE√á√ÉO PRINCIPAL AQUI ---
    window.updateItemQty = (index, newQty) => {
        const item = orcamentoItens[index];
        const qty = parseInt(newQty);

        if (qty <= 0) return; // Evita quantidade zero ou negativa

        item.qty = qty;

        // Se N√ÉO for um sub-item (ou seja, √© um produto), recalcula o pre√ßo unit√°rio baseado nas regras
        if (!item.isSubItem) {
            // Tenta achar o produto original pelo nome para pegar as regras de pre√ßo
            const originalProduct = products.find(p => p.nome === item.desc);

            if (originalProduct) {
                // Recalcula o pre√ßo unit√°rio baseado na nova quantidade
                let newUnit = originalProduct.precoBase;
                if (originalProduct.rules) {
                    for (let r of originalProduct.rules) {
                        if (qty >= r.qty) {
                            newUnit = r.price;
                            break;
                        }
                    }
                }
                item.unit = newUnit;
            }
        }

        // Atualiza o subtotal
        item.sub = item.qty * item.unit;
        renderOrcamento();
    };

    // Drag and Drop Logic
    let dragSrcEl = null;

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        this.classList.add('over');
    }

    function handleDragLeave(e) {
        this.classList.remove('over');
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        const dragIdx = parseInt(dragSrcEl.getAttribute('data-index'));
        const dropIdx = parseInt(this.getAttribute('data-index'));

        if (dragIdx !== dropIdx) {
            // Move o item no array
            const itemToMove = orcamentoItens[dragIdx];
            orcamentoItens.splice(dragIdx, 1);
            orcamentoItens.splice(dropIdx, 0, itemToMove);
            renderOrcamento();
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        let items = document.querySelectorAll('.draggable-row');
        items.forEach(function (item) {
            item.classList.remove('over');
        });
    }

    window.renderOrcamento = () => {
        const b = document.getElementById('orcBody'); 
        b.innerHTML = ''; 
        let t = 0;

        orcamentoItens.forEach((item, i) => { 
            t += item.sub; 
            const row = document.createElement('tr');
            row.className = item.isSubItem ? 'sub-item draggable-row' : 'draggable-row';
            row.setAttribute('draggable', 'true');
            row.setAttribute('data-index', i);

            // Eventos de Drag and Drop
            row.addEventListener('dragstart', handleDragStart, false);
            row.addEventListener('dragenter', handleDragEnter, false);
            row.addEventListener('dragover', handleDragOver, false);
            row.addEventListener('dragleave', handleDragLeave, false);
            row.addEventListener('drop', handleDrop, false);
            row.addEventListener('dragend', handleDragEnd, false);

            row.innerHTML = `
                <td class="no-print" style="cursor: grab; text-align:center; color:var(--text-muted)">‚ò∞</td>
                <td>${item.desc}</td>
                <td align="center">
                    <input type="number" class="editable-qty" value="${item.qty}" onchange="updateItemQty(${i}, this.value)">
                </td>
                <td align="right">R$ ${item.unit.toFixed(3)}</td>
                <td align="right">R$ ${item.sub.toFixed(2)}</td>
                <td class="no-print" style="text-align: center;">
                    <button class="btn btn-sm btn-success" onclick="duplicateOrcItem(${i})" title="Duplicar">+</button>
                    <button class="btn btn-sm btn-danger" onclick="removeOrcItem(${i})" title="Remover">X</button>
                </td>
            `;
            b.appendChild(row);
        });
        document.getElementById('resTotal').innerText = `R$ ${t.toLocaleString('pt-br', {minimumFractionDigits: 2})}`;
    };

    window.carregarOrc = (n) => { 
        const h = historico.find(x => x.numero == n); 
        document.getElementById('orcNumeroDisplay').innerText = h.numero.toString().padStart(3,'0'); 
        document.getElementById('resCliNome').innerText = h.cliente.nome; document.getElementById('resCliDoc').innerText = h.cliente.doc; 
        document.getElementById('resCliFone').innerText = h.cliente.fone; document.getElementById('resCliEnd').innerText = h.cliente.end; 
        document.getElementById('resPagamento').innerText = h.pagamento; 
        orcamentoItens = [...h.itens]; renderOrcamento(); 
        document.getElementById('areaPrintavel').scrollIntoView(); 
    };

    window.updateOrcamentoVisual = () => { document.getElementById('resPagamento').innerText = document.getElementById('selectPagamento').value; };
    window.limparOrcamento = () => { orcamentoItens = []; document.getElementById('orcBody').innerHTML = ''; document.getElementById('resTotal').innerText = 'R$ 0,00'; };

    function render() {
        document.getElementById('orcData').innerText = new Date().toLocaleDateString();
        const prox = historico.length > 0 ? Math.max(...historico.map(h => h.numero)) + 1 : 1;
        document.getElementById('orcNumeroDisplay').innerText = prox.toString().padStart(3,'0');

        // Renderiza Datalists (Busca com Lupa)
        document.getElementById('listClientes').innerHTML = clientes.map(c=>`<option value="${c.nome}">`).join('');
        document.getElementById('listProdutos').innerHTML = products.map(p=>`<option value="${p.nome}">`).join('');

        document.getElementById('selectArte').innerHTML = '<option value="0">Sem Arte</option>' + artes.map(a=>`<option value="${a.preco}">${a.nome}</option>`).join('');

        renderModalTables();
        renderHistorico();
    }

    function renderModalTables() {
        const cliT = document.querySelector('#cliTable tbody'); cliT.innerHTML = '';
        clientes.forEach(c => cliT.innerHTML += `<tr><td>${c.nome}</td><td style="text-align:right"><button class="btn btn-sm btn-outline" onclick="editCliente('${c.id}')">‚úèÔ∏è</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('grafica_clis', '${c.id}')">X</button></td></tr>`);

        const artT = document.querySelector('#arteTable tbody'); artT.innerHTML = '';
        artes.forEach(a => artT.innerHTML += `<tr><td>${a.nome} (R$ ${a.preco.toFixed(3)})</td><td style="text-align:right"><button class="btn btn-sm btn-outline" onclick="editArte('${a.id}')">‚úèÔ∏è</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('grafica_artes', '${a.id}')">X</button></td></tr>`);

        const prdT = document.querySelector('#prodTable tbody'); prdT.innerHTML = '';
        products.forEach(p => {
            const estoque = p.estoque ? p.estoque : 0;
            prdT.innerHTML += `<tr><td>${p.nome} <br><span style="font-size:0.8rem; color:var(--text-muted)">Base: R$${p.precoBase} | Est: ${estoque}</span></td><td style="text-align:right"><button class="btn btn-sm btn-outline" onclick="editProd('${p.id}')">‚úèÔ∏è</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('grafica_prods', '${p.id}')">X</button></td></tr>`;
        });
    }

    function renderHistorico() {
        const b = document.querySelector('#historicoTable tbody'); b.innerHTML = '';
        historico.forEach(h => b.innerHTML += `<tr><td>#${h.numero}</td><td>${h.data}</td><td>${h.cliente.nome}</td><td>${h.total}</td><td style="text-align:right"><button class="btn btn-sm btn-primary" onclick="carregarOrc(${h.numero})">Ver</button> <button class="btn btn-sm btn-danger" onclick="deleteHistorico('${h.id}')">X</button></td></tr>`);
    }

    // --- EVENTO DE TECLADO (ESC) ---
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal.style.display === 'flex') {
                closeModal();
            }
        }
    });

    // Inicializa√ß√£o
    addRuleField();
    initUsers(); // Cria usu√°rios se n√£o existirem

    // Checa tema salvo
    if(localStorage.getItem('grafica_theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }
</script>
</body>
</html>
